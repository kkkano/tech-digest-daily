name: Tech Digest Daily

on:
  # æ¯å¤© UTC 23:00 è¿è¡Œ = åŒ—äº¬æ—¶é—´ 7:00
  schedule:
    - cron: '0 23 * * *'

  # æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  workflow_dispatch:
    inputs:
      enable_ai:
        description: 'å¯ç”¨ AI æ€»ç»“'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

# éœ€è¦å†™å…¥æƒé™æ¥æäº¤å†å²è®°å½•
permissions:
  contents: write

jobs:
  send-digest:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install -r requirements.txt

      - name: ğŸš€ è·å–èµ„è®¯å¹¶å‘é€é‚®ä»¶
        env:
          # å¿…éœ€é…ç½®
          TO_EMAIL: ${{ secrets.TO_EMAIL }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}

          # AI æ€»ç»“é…ç½®
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          GITHUB_USERNAME: ${{ secrets.GITHUB_USERNAME }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          # æ•°æ®æºå¼€å…³ (true/false)
          ENABLE_GITHUB: 'true'
          ENABLE_HACKERNEWS: 'true'
          ENABLE_PRODUCTHUNT: 'true'
          ENABLE_DEVTO: 'true'

          # æ•°é‡é…ç½®
          GITHUB_LIMIT: '15'
          HACKERNEWS_LIMIT: '10'
          PRODUCTHUNT_LIMIT: '8'
          DEVTO_LIMIT: '10'

          # AI æ€»ç»“å¼€å…³
          ENABLE_AI_SUMMARY: ${{ github.event.inputs.enable_ai || 'true' }}

          # å†å²å»é‡å¼€å…³
          ENABLE_HISTORY_DEDUP: 'true'

          # å¯é€‰ï¼šä½¿ç”¨ SMTP æ›¿ä»£ Resend
          # SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          # SMTP_PORT: ${{ secrets.SMTP_PORT }}
          # SMTP_USER: ${{ secrets.SMTP_USER }}
          # SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        run: |
          cd src
          python main.py

      - name: ğŸ’¾ æäº¤å†å²è®°å½•
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # æ£€æŸ¥æ˜¯å¦æœ‰å†å²æ–‡ä»¶éœ€è¦æäº¤
          if [ -f "data/history.json" ]; then
            git add data/history.json
            git diff --staged --quiet || git commit -m "chore: update dedup history [skip ci]"
            git push || echo "No changes to push"
          fi

      - name: ğŸ“Š ä»»åŠ¡çŠ¶æ€
        if: always()
        run: |
          echo "ä»»åŠ¡å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
